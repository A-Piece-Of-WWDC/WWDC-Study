# Author fast and reliable tests for Xcode Cloud

우리의 테스트 코드는 프로젝트의 규모가 커짐에 따라 점점 방대해진다. 그 과정 속에서 우리는 관리가 되지 않아 방치된 일부 테스트 코드에 대한 신뢰성을 잃을 수 있고, 길어진 테스트 실행 시간으로 인해 작업의 효율성이 저하될 수 있다. 이러한 일을 방지하기 위해 Xcode Cloud를 활용한다면 우리는 좀 더 신뢰할만한 테스트, 그리고 효율적인 테스트를 얻을 수 있다.

## Authoring reliable tests

1. 테스트 코드에서 setUp()과 tearDown()메서드가 잘 실행되고 있는지 확인해야 한다
    1. 이유: Xcode Cloud에서 실행되는 테스트는 새로운 시뮬레이터를 사용하기 때문에 개발자의 로컬 환경과 달라질 수 있기 떄문
    2. 테스트 코드를 세팅하는 과정에서 챙겨야할 요소들
        1. 로컬 날짜와 시간을 쓰지 말자. 특정 시간대가 되는 것을 피해야한다
            1. Xcode Cloud 환경에서의 서버가 다른 시간대에서 실행될 수 있음
        2. 미리 테스트에 사용할 의존할 수 있는 데이터들을 준비해두자
        3. setUp메서드에서 모든 상태에 대한 준비를 해두는 것이 좋다
            
            ![스크린샷 2022-12-15 오후 7 13 58](https://user-images.githubusercontent.com/87598209/207849812-060ce82d-b775-401f-8292-7b9ab8871dda.png)


1. 전제 조건을 충족하지 못하는 테스트가 존재한다면 XCTSkip을 활용해라
    1. 아직 미지원되는 OS버전이나 기기 유형 우회에 효과적으로 사용할 수 있다
    2. Xcode Cloud와 Test Plan의 환경변수를 활용한다면 환경을 분리해서 테스트해줄 수 있다
        1. Xcode Cloud 환경변수에는 접두어 `TEST_RUNNER_` 가 붙음
            1. ex) BASE_URL → TEST_RUNNER_BASE_URL
        2. Test plan의 환경변수에는 접두어가 붙지 않음
        3. 두 개의 환경변수가 모두 사용될 수 있는 상황에서는 항상 Xcode cloud의 환경변수가 우선적으로 사용됨
2. 만약 시간초과로 인해 테스트가 실패할 경우 XCTestExpectation의 타임을 늘리거나 async/await을 활용하자
    1. 가장 나이브한 방법을 사용한다면 timeout시간을 기존 5초에서 10초로 늘리자
    
        ![스크린샷 2022-12-15 오후 7 40 34](https://user-images.githubusercontent.com/87598209/207850254-d077a5df-cd69-4c99-bb5d-d41403553c03.png)

    2. async/await API를 활용하자(권장)
        1. 훨씬 코드도 간결해지고 timeout을 줄 필요도 없음
        
        ![스크린샷 2022-12-15 오후 8 41 04](https://user-images.githubusercontent.com/87598209/207850434-92685973-7bf8-4b17-805f-7ed1b48b4b39.png)

3. 실패가 예상되는 테스트가 있다면 XCTExpectFailure을 활용하자
    
    ![스크린샷 2022-12-15 오후 7 44 41](https://user-images.githubusercontent.com/87598209/207849878-58a60326-ffcc-45b6-8c25-a14306d1801d.png)

    1. 만약 서버가 임시 점검중이라서 테스트 코드가 계속 실패한다면 위의 코드처럼 활용할 수 있다.
    2. 통과로 여겨진다고 하는데 실제로 해보니 실패로 나옴. 좀 더 확인 필요
4. 테스트를 반복하자
    1. 만약 테스트의 성공률이 80%라면 분명 문제가 있는 테스트 코드이다.
    2. 이럴 경우 테스트를 실패할 때까지 반복하여 테스트코드에 대한 검증이 필요함
        1. 그러면 실패할 때까지 영구적으로 반복하나 싶어서 테스트해봤는데 그건 아니고 테스트당 최대 횟수 제한을 둘 수 있음
    3. 반대로 만약에, 상대적으로 의존하기 힘든 외부 서비스에 대한 테스트 코드를 작성한 경우는 일시적으로 실패할 수도 있으므로 실패 시 성공할 때까지 반복 모드를 줄 수 있다
    4. Test plan → Configurations에 설정해줄 수 있음
        
        ![스크린샷 2022-12-15 오후 7 55 13](https://user-images.githubusercontent.com/87598209/207849961-ddc4082e-9e0f-45a3-a0bb-1cd6c342601b.png)


## Configuring for faster results

1. 효율적인 테스트 구성을 위해 할 수 있는 가장 효과적인 방법은 테스트들을 여러 테스트 플랜으로 분할하는 것
    1. 풀리퀘스트 테스트 전용 워크플로우를 만들자
        
        ![스크린샷 2022-12-15 오후 8 02 03](https://user-images.githubusercontent.com/87598209/207849977-81accaa9-522d-47c5-bbb7-a45d39003e0e.png)

    2. 풀리퀘스트 테스트 플랜을 만들어서 필요한 테스트만 하자
2. 테스트 동시 실행
    1. 테스트 플랜에서 동시 실행 옵션을 활성화하자
        1. 사용 가능한 코어가 충분하다면 테스트를 병렬로 실행하게 된다
        2. 해당 옵션을 쓰기 위해서는 각각의 테스트가 반드시 서로 독립적이게끔 설게되어야함
            
            ![스크린샷 2022-12-15 오후 8 10 17](https://user-images.githubusercontent.com/87598209/207849995-4fd3fc61-8ba1-491c-a43c-3d9027e1cb35.png)

3. 테스트 플랜에서 실행 시간 제한을 둠으로써, 런어웨이 테스트를 방지하자
    1. 런어웨이 테스트란, 예상되는 시간안에 끝나지 않는 테스트를 의미한다
        1. 무한 루프가 돌거나, 서버로부터 실패한 요청에 대한 무한정 대기가 포함될 수 있음
    2. Configuration을 통해 제한 시간을 두자

![스크린샷 2022-12-15 오후 8 18 28](https://user-images.githubusercontent.com/87598209/207850031-e3e8f503-bb94-494f-9aec-beba3db6bb36.png)

